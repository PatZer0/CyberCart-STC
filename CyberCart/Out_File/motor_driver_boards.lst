C251 COMPILER V5.60.0,  motor_driver_boards                                                26/04/24  14:43:24  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE motor_driver_boards
OBJECT MODULE PLACED IN .\Out_File\motor_driver_boards.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE Project\CODE\motor_driver_boards.c XSMALL INTR2 WARNINGLEVEL(3) OPTIMI
                    -ZE(0,SPEED) BROWSE INCDIR(Libraries\libraries;Libraries\seekfree_libraries;Libraries\seekfree_peripheral;Project\CODE;Pr
                    -oject\USER\inc;Project\USER\src;Libraries\seekfree_components) DEBUG PRINT(.\Out_File\motor_driver_boards.lst) TABS(2) O
                    -BJECT(.\Out_File\motor_driver_boards.obj) 

stmt  level    source

    1          #include "motor_driver_boards.h"
    2          #include "qmc5883.h"
    3          
    4          int     wheel_x_front_speed = 0, wheel_x_rear_speed = 0, wheel_y_front_speed = 0, wheel_y_rear_speed = 0;
    5          float   wheel_target_yaw;
    6          bit     wheel_yaw_calibrating_flag = 0;
    7          
    8          // void motor_drivers_pwm_init()
    9          // {
   10          //     // ÂèÇÊï∞ÔºöÊ®°Âùó_Á´ØÂè£, È¢ëÁéá, Âç†Á©∫ÊØî(√∑10000)
   11          //     pwm_init(PWMA_CH1P_P60, 30000, 1000);   // XÊñπÂêëÈ©±Âä®ÊùøPB, 3KHz, 10%Âç†Á©∫ÊØî
   12          //     pwm_init(PWMA_CH2N_P63, 30000, 1000);   // XÊñπÂêëÈ©±Âä®ÊùøPAÔºå3KHz, 10%Âç†Á©∫ÊØî
   13          //     pwm_init(PWMA_CH4N_P67, 30000, 1000);   // YÊñπÂêëÈ©±Âä®ÊùøPB, 3KHz, 10%Âç†Á©∫ÊØî
   14          //     pwm_init(PWMA_CH3P_P14, 30000, 1000);   // YÊñπÂêëÈ©±Âä®ÊùøPA, 3KHz, 10%Âç†Á©∫ÊØî
   15          // }
   16          
   17          //-------------------------------------------------------------------------------------------------------
             -------------
   18          //  @brief      Ë∞ÉÊï¥ËΩÆÂ≠êÊñπÂêë
   19          //  @param      <X/Y>_<FRONT/REAR/ALL>      ÊåáÂÆöËΩÆÂ≠ê
   20          //  @param      <FORWARD/BACKWARD/STOP>     ÊåáÂÆöÊñπÂêë
   21          //  @return     void
   22          //  @since      v1.0 by PatZer0 on 2024.04.18
   23          //  *example  wheel_direction(X_FRONT, FORWARD); // XÊñπÂêëÂâçËΩÆÊ≠£ËΩ¨
   24          //  *desc       Êó†Ë°•ÂÖÖÊèèËø∞
   25          //-------------------------------------------------------------------------------------------------------
             -------------
   26          void wheel_direction(WHEEL_SEL_enum wheel_select, WHEEL_DIR_enum wheel_direction)
   27          {
   28   1          switch (wheel_select)
   29   1          {
   30   2              case X_FRONT:
   31   2                  if (wheel_direction == FORWARD)
   32   2                  {
   33   3                      gpio_wheel_x_front_forward = 1;
   34   3                      gpio_wheel_x_front_backward = 0;
   35   3                  }
   36   2                  else if (wheel_direction == BACKWARD)
   37   2                  {
   38   3                      gpio_wheel_x_front_forward = 0;
   39   3                      gpio_wheel_x_front_backward = 1;
   40   3                  }
   41   2                  else if (wheel_direction == STOP)
   42   2                  {
   43   3                      gpio_wheel_x_front_forward = 0;
   44   3                      gpio_wheel_x_front_backward = 0;
   45   3                  }
   46   2                  break;
   47   2              case X_REAR:
   48   2                  if (wheel_direction == FORWARD)
   49   2                  {
   50   3                      gpio_wheel_x_rear_forward = 1;
   51   3                      gpio_wheel_x_rear_backward = 0;
   52   3                  }
   53   2                  else if (wheel_direction == BACKWARD)
   54   2                  {
C251 COMPILER V5.60.0,  motor_driver_boards                                                26/04/24  14:43:24  PAGE 2   

   55   3                      gpio_wheel_x_rear_forward = 0;
   56   3                      gpio_wheel_x_rear_backward = 1;
   57   3                  }
   58   2                  else if (wheel_direction == STOP)
   59   2                  {
   60   3                      gpio_wheel_x_rear_forward = 0;
   61   3                      gpio_wheel_x_rear_backward = 0;
   62   3                  }
   63   2                  break;
   64   2              case X_ALL:
   65   2                  if (wheel_direction == FORWARD)
   66   2                  {
   67   3                      gpio_wheel_x_front_forward = 1;
   68   3                      gpio_wheel_x_front_backward = 0;
   69   3                      gpio_wheel_x_rear_forward = 1;
   70   3                      gpio_wheel_x_rear_backward = 0;
   71   3                  }
   72   2                  else if (wheel_direction == BACKWARD)
   73   2                  {
   74   3                      gpio_wheel_x_front_forward = 0;
   75   3                      gpio_wheel_x_front_backward = 1;
   76   3                      gpio_wheel_x_rear_forward = 0;
   77   3                      gpio_wheel_x_rear_backward = 1;
   78   3                  }
   79   2                  else if (wheel_direction == STOP)
   80   2                  {
   81   3                      gpio_wheel_x_front_forward = 0;
   82   3                      gpio_wheel_x_front_backward = 0;
   83   3                      gpio_wheel_x_rear_forward = 0;
   84   3                      gpio_wheel_x_rear_backward = 0;
   85   3                  }
   86   2                  break;
   87   2              case Y_FRONT:
   88   2                  if (wheel_direction == FORWARD)
   89   2                  {
   90   3                      gpio_wheel_y_front_forward = 1;
   91   3                      gpio_wheel_y_front_backward = 0;
   92   3                  }
   93   2                  else if (wheel_direction == BACKWARD)
   94   2                  {
   95   3                      gpio_wheel_y_front_forward = 0;
   96   3                      gpio_wheel_y_front_backward = 1;
   97   3                  }
   98   2                  else if (wheel_direction == STOP)
   99   2                  {
  100   3                      gpio_wheel_y_front_forward = 0;
  101   3                      gpio_wheel_y_front_backward = 0;
  102   3                  }
  103   2                  break;
  104   2              case Y_REAR:
  105   2                  if (wheel_direction == FORWARD)
  106   2                  {
  107   3                      gpio_wheel_y_rear_forward = 1;
  108   3                      gpio_wheel_y_rear_backward = 0;
  109   3                  }
  110   2                  else if (wheel_direction == BACKWARD)
  111   2                  {
  112   3                      gpio_wheel_y_rear_forward = 0;
  113   3                      gpio_wheel_y_rear_backward = 1;
  114   3                  }
  115   2                  else if (wheel_direction == STOP)
  116   2                  {
  117   3                      gpio_wheel_y_rear_forward = 0;
  118   3                      gpio_wheel_y_rear_backward = 0;
  119   3                  }
  120   2                  break;
C251 COMPILER V5.60.0,  motor_driver_boards                                                26/04/24  14:43:24  PAGE 3   

  121   2              case Y_ALL:
  122   2                  if (wheel_direction == FORWARD)
  123   2                  {
  124   3                      gpio_wheel_y_front_forward = 1;
  125   3                      gpio_wheel_y_front_backward = 0;
  126   3                      gpio_wheel_y_rear_forward = 1;
  127   3                      gpio_wheel_y_rear_backward = 0;
  128   3                  }
  129   2                  else if (wheel_direction == BACKWARD)
  130   2                  {
  131   3                      gpio_wheel_y_front_forward = 0;
  132   3                      gpio_wheel_y_front_backward = 1;
  133   3                      gpio_wheel_y_rear_forward = 0;
  134   3                      gpio_wheel_y_rear_backward = 1;
  135   3                  }
  136   2                  else if (wheel_direction == STOP)
  137   2                  {
  138   3                      gpio_wheel_y_front_forward = 0;
  139   3                      gpio_wheel_y_front_backward = 0;
  140   3                      gpio_wheel_y_rear_forward = 0;
  141   3                      gpio_wheel_y_rear_backward = 0;
  142   3                  }
  143   2                  break;
  144   2              case ALL:
  145   2                  if (wheel_direction == FORWARD)
  146   2                  {
  147   3                      gpio_wheel_x_front_forward = 1;
  148   3                      gpio_wheel_x_front_backward = 0;
  149   3                      gpio_wheel_x_rear_forward = 1;
  150   3                      gpio_wheel_x_rear_backward = 0;
  151   3                      gpio_wheel_y_front_forward = 1;
  152   3                      gpio_wheel_y_front_backward = 0;
  153   3                      gpio_wheel_y_rear_forward = 1;
  154   3                      gpio_wheel_y_rear_backward = 0;
  155   3                  }
  156   2                  else if (wheel_direction == BACKWARD)
  157   2                  {
  158   3                      gpio_wheel_x_front_forward = 0;
  159   3                      gpio_wheel_x_front_backward = 1;
  160   3                      gpio_wheel_x_rear_forward = 0;
  161   3                      gpio_wheel_x_rear_backward = 1;
  162   3                      gpio_wheel_y_front_forward = 0;
  163   3                      gpio_wheel_y_front_backward = 1;
  164   3                      gpio_wheel_y_rear_forward = 0;
  165   3                      gpio_wheel_y_rear_backward = 1;
  166   3                  }
  167   2                  else if (wheel_direction == STOP)
  168   2                  {
  169   3                      gpio_wheel_x_front_forward = 0;
  170   3                      gpio_wheel_x_front_backward = 0;
  171   3                      gpio_wheel_x_rear_forward = 0;
  172   3                      gpio_wheel_x_rear_backward = 0;
  173   3                      gpio_wheel_y_front_forward = 0;
  174   3                      gpio_wheel_y_front_backward = 0;
  175   3                      gpio_wheel_y_rear_forward = 0;
  176   3                      gpio_wheel_y_rear_backward = 0;
  177   3                  }
  178   2                  break;
  179   2              default:
  180   2                  break;
  181   2          }
  182   1      }
  183          
  184          //-------------------------------------------------------------------------------------------------------
             -------------
  185          //  @brief      Ë∞ÉÊï¥ÁîµÊú∫ËΩ¨ÈÄüÂíåÊñπÂêë
C251 COMPILER V5.60.0,  motor_driver_boards                                                26/04/24  14:43:24  PAGE 4   

  186          //  @param      <X/Y>_<FRONT/REAR/ALL>      ÊåáÂÆöËΩÆÂ≠ê
  187          //  @param      speed                       ËΩ¨ÈÄüÂÄºÔºåËåÉÂõ¥Ë¥ü10000~Ê≠£10000
  188          //  @return     void
  189          //  @since      v1.0 by PatZer0 on 2024.04.18
  190          //  *example  wheel_adjust(X_FRONT, 5000); // XÊñπÂêëÂâçËΩÆÂêëÂâçËΩ¨, ËΩ¨ÈÄü50%
  191          //  *desc       ‰∏ÄËà¨ÊÉÖÂÜµ‰∏ãÔºåÁõ¥Êé•‰ΩøÁî®Ê≠§ÂáΩÊï∞Âç≥ÂèØÔºåÈô§ÈùûÈúÄË¶Å‰øùÊåÅËΩ¨ÈÄüË∞ÉÊï¥ÊñπÂêëÔºåÂê
             -¶Âàô‰∏çÈúÄË¶Å‰ΩøÁî®Êç¢ÂêëÂáΩÊï∞
  192          //-------------------------------------------------------------------------------------------------------
             -------------
  193          void wheel_adjust(WHEEL_SEL_enum wheel_select, int speed)
  194          {
  195   1          unsigned int pwm_duty_value;
  196   1      
  197   1          // Êõ¥ÊîπËΩÆÂ≠êÊñπÂêë
  198   1          if      (speed > 0) wheel_direction(wheel_select, FORWARD);
  199   1          else if (speed < 0) wheel_direction(wheel_select, BACKWARD);
  200   1          else                wheel_direction(wheel_select, STOP);
  201   1      
  202   1          // Á°ÆÂÆöPWMÂç†Á©∫ÊØî
  203   1          if (speed >= 0) pwm_duty_value = speed;
  204   1          else            pwm_duty_value = -speed;
  205   1      
  206   1          // Ê†°ÂáÜÈÄüÂ∫¶ËæìÂÖ•ÈáèÔºåÈôêÂà∂Âú®ËåÉÂõ¥ÂÜÖ
  207   1          if      (speed > WHEEL_PWM_MAX_VAL)     speed = WHEEL_PWM_MAX_VAL;
  208   1          else if (speed < -WHEEL_PWM_MAX_VAL)    speed = -WHEEL_PWM_MAX_VAL;
  209   1      
  210   1          switch (wheel_select)
  211   1          {
  212   2              case X_FRONT:
  213   2                  pwm_duty(WHEEL_X_FRONT_PWMCH, pwm_duty_value);
  214   2                  break;
  215   2              case X_REAR:
  216   2                  pwm_duty(WHEEL_X_REAR_PWMCH, pwm_duty_value);
  217   2                  break;
  218   2              case X_ALL:
  219   2                  pwm_duty(WHEEL_X_FRONT_PWMCH, pwm_duty_value);
  220   2                  pwm_duty(WHEEL_X_REAR_PWMCH, pwm_duty_value);
  221   2                  break;
  222   2              case Y_FRONT:
  223   2                  pwm_duty(WHEEL_Y_FRONT_PWMCH, pwm_duty_value);
  224   2                  break;
  225   2              case Y_REAR:
  226   2                  pwm_duty(WHEEL_Y_REAR_PWMCH, pwm_duty_value);
  227   2                  break;
  228   2              case Y_ALL:
  229   2                  pwm_duty(WHEEL_Y_FRONT_PWMCH, pwm_duty_value);
  230   2                  pwm_duty(WHEEL_Y_REAR_PWMCH, pwm_duty_value);
  231   2                  break;
  232   2              case ALL:
  233   2                  pwm_duty(WHEEL_X_FRONT_PWMCH, pwm_duty_value);
  234   2                  pwm_duty(WHEEL_X_REAR_PWMCH, pwm_duty_value);
  235   2                  pwm_duty(WHEEL_Y_FRONT_PWMCH, pwm_duty_value);
  236   2                  pwm_duty(WHEEL_Y_REAR_PWMCH, pwm_duty_value);
  237   2                  break;
  238   2              default:
  239   2                  break;
  240   2          }
  241   1      }
  242          
  243          //-------------------------------------------------------------------------------------------------------
             -------------
  244          //  @brief      Ë∞ÉÊï¥ÁîµÊú∫ËΩ¨ÈÄü
  245          //  @param      <X/Y>_<FRONT/REAR/ALL>      ÊåáÂÆöËΩÆÂ≠ê
  246          //  @param      speed                       ËΩ¨ÈÄüÂÄºÔºåËåÉÂõ¥0~10000
  247          //  @return     void
  248          //  @since      v1.0 by PatZer0 on 2024.04.18
C251 COMPILER V5.60.0,  motor_driver_boards                                                26/04/24  14:43:24  PAGE 5   

  249          //  *example  wheel_speed(X_FRONT, 5000); // XÊñπÂêëÂâçËΩÆÂêëÂâçËΩ¨, ËΩ¨ÈÄü50%
  250          //  *desc       ‰∏ÄËà¨ÊÉÖÂÜµ‰∏ãÔºåÁõ¥Êé•‰ΩøÁî®Ê≠§ÂáΩÊï∞Âç≥ÂèØÔºåÈô§ÈùûÈúÄË¶Å‰øùÊåÅËΩ¨ÈÄüË∞ÉÊï¥ÊñπÂêëÔºåÂê
             -¶Âàô‰∏çÈúÄË¶Å‰ΩøÁî®Êç¢ÂêëÂáΩÊï∞
  251          //-------------------------------------------------------------------------------------------------------
             -------------
  252          void wheel_speed(WHEEL_SEL_enum wheel_select, unsigned int speed)
  253          {
  254   1          unsigned int pwm_duty_value;
  255   1          if (speed > WHEEL_PWM_MAX_VAL) pwm_duty_value = WHEEL_PWM_MAX_VAL;
  256   1      
  257   1          switch (wheel_select)
  258   1          {
  259   2              case X_FRONT:
  260   2                  pwm_duty(WHEEL_X_FRONT_PWMCH, pwm_duty_value);
  261   2                  break;
  262   2              case X_REAR:
  263   2                  pwm_duty(WHEEL_X_REAR_PWMCH, pwm_duty_value);
  264   2                  break;
  265   2              case X_ALL:
  266   2                  pwm_duty(WHEEL_X_FRONT_PWMCH, pwm_duty_value);
  267   2                  pwm_duty(WHEEL_X_REAR_PWMCH, pwm_duty_value);
  268   2                  break;
  269   2              case Y_FRONT:
  270   2                  pwm_duty(WHEEL_Y_FRONT_PWMCH, pwm_duty_value);
  271   2                  break;
  272   2              case Y_REAR:
  273   2                  pwm_duty(WHEEL_Y_REAR_PWMCH, pwm_duty_value);
  274   2                  break;
  275   2              case Y_ALL:
  276   2                  pwm_duty(WHEEL_Y_FRONT_PWMCH, pwm_duty_value);
  277   2                  pwm_duty(WHEEL_Y_REAR_PWMCH, pwm_duty_value);
  278   2                  break;
  279   2              case ALL:
  280   2                  pwm_duty(WHEEL_X_FRONT_PWMCH, pwm_duty_value);
  281   2                  pwm_duty(WHEEL_X_REAR_PWMCH, pwm_duty_value);
  282   2                  pwm_duty(WHEEL_Y_FRONT_PWMCH, pwm_duty_value);
  283   2                  pwm_duty(WHEEL_Y_REAR_PWMCH, pwm_duty_value);
  284   2                  break;
  285   2              default:
  286   2                  break;
  287   2          }
  288   1      }
  289          
  290          //-------------------------------------------------------------------------------------------------------
             -------------
  291          //  @brief      Ê†πÊçÆÂÖ®Â±ÄÂèòÈáèÂä®ÊÄÅË∞ÉÊï¥ÁîµÊú∫ËΩ¨ÈÄü
  292          //  @param      void
  293          //  @since      v1.0 by PatZer0 on 2024.04.24
  294          //  *example  void
  295          //  *desc       ‰ΩøÁî®Âõõ‰∏™ÂÖ®Â±ÄÂèòÈáèÔºåÂä®ÊÄÅË∞ÉÊï¥ËΩÆÂ≠êËΩ¨ÈÄüÔºåÂ∞ÜÊ≠§ÂáΩÊï∞ÊîæÂú®while(1)‰∏≠ËøêË°å
             -ÔºåÁÑ∂Âêé‰øÆÊîπÂÖ®Â±ÄÂèòÈáèÂç≥ÂèØ
  296          //-------------------------------------------------------------------------------------------------------
             -------------
  297          void wheel_dynamic_adjusting()
  298          {
  299   1          wheel_adjust(X_FRONT, wheel_x_front_speed);
  300   1          wheel_adjust(X_REAR, wheel_x_rear_speed);
  301   1          wheel_adjust(Y_FRONT, wheel_y_front_speed);
  302   1          wheel_adjust(Y_REAR, wheel_y_rear_speed);
  303   1      }
  304          
  305          void wheel_dynamic_calibrating()
  306          {
  307   1          
  308   1      }
  309          
C251 COMPILER V5.60.0,  motor_driver_boards                                                26/04/24  14:43:24  PAGE 6   

  310          #define WHEEL_YAW_CALIBRATING_THRESHOLD 0.5
  311          #define WHEEL_TURNING_SPEED_FAST 5000
  312          #define WHEEL_TURNING_SPEED_SLOW 1000
  313          
  314          void wheel_yaw_calibrating()
  315          {
  316   1          if(wheel_yaw_calibrating_flag)
  317   1          {
  318   2              // ÂêëÂ∑¶ËΩ¨ÂÅèËΩ¨Ëßí+ÔºåÂêëÂè≥ËΩ¨ÂÅèËΩ¨Ëßí-
  319   2              // ÂΩìÂâçËßíÂ∫¶-ÂÅèËΩ¨ËßíÂ∫¶<0ÔºåËØ¥ÊòéÂÅèËΩ¨ËßíÂ∫¶Â§ß‰∫éÂΩìÂâçËßíÂ∫¶ÔºåÈúÄË¶ÅÂ∑¶ËΩ¨
  320   2              if((qmc5883_yaw - wheel_target_yaw < 0) && (qmc5883_yaw - wheel_target_yaw > WHEEL_YAW_CALIBRATIN
             -G_THRESHOLD))  
  321   2              {
  322   3                  wheel_y_front_speed = WHEEL_TURNING_SPEED_FAST;         // ÂΩìËøòÊú™ËææÂà∞ÁõÆÊ†áËßíÂ∫¶Êó∂ÔºåÂ
             -ä†ÈÄüËΩ¨Âêë
  323   3              }
  324   2              else if((qmc5883_yaw - wheel_target_yaw < 0) && (qmc5883_yaw - wheel_target_yaw < WHEEL_YAW_CALIB
             -RATING_THRESHOLD))
  325   2              {
  326   3                  wheel_y_front_speed = WHEEL_TURNING_SPEED_SLOW;        // ÂΩìËææÂà∞ÁõÆÊ†áËßíÂ∫¶Êó∂ÔºåÂÅúÊ≠¢ËΩ
             -¨Âêë
  327   3              }
  328   2      
  329   2              // ÂΩìÂâçËßíÂ∫¶-ÂÅèËΩ¨ËßíÂ∫¶>0ÔºåËØ¥ÊòéÂÅèËΩ¨ËßíÂ∫¶Â∞è‰∫éÂΩìÂâçËßíÂ∫¶ÔºåÈúÄË¶ÅÂè≥ËΩ¨
  330   2              if((qmc5883_yaw - wheel_target_yaw > 0) && (qmc5883_yaw - wheel_target_yaw < -WHEEL_YAW_CALIBRATI
             -NG_THRESHOLD))
  331   2              {
  332   3                  wheel_y_front_speed = -WHEEL_TURNING_SPEED_FAST;        // ÂΩìËøòÊú™ËææÂà∞ÁõÆÊ†áËßíÂ∫¶Êó∂ÔºåÂ
             -ä†ÈÄüËΩ¨Âêë
  333   3              }
  334   2              else if((qmc5883_yaw - wheel_target_yaw > 0) && (qmc5883_yaw - wheel_target_yaw > -WHEEL_YAW_CALI
             -BRATING_THRESHOLD))
  335   2              {
  336   3                  wheel_y_front_speed = -WHEEL_TURNING_SPEED_SLOW;       // ÂΩìËææÂà∞ÁõÆÊ†áËßíÂ∫¶Êó∂ÔºåÂÅúÊ≠¢ËΩ
             -¨Âêë
  337   3              }
  338   2      
  339   2              // ËßíÂ∫¶ËØØÂ∑ÆÂ∞è‰∫éÈòàÂÄºÊó∂ÔºåÂÅúÊ≠¢ËΩ¨Âêë
  340   2              if(qmc5883_yaw - wheel_target_yaw < WHEEL_YAW_CALIBRATING_THRESHOLD)
  341   2              {
  342   3                  wheel_yaw_calibrating_flag = 0;         // Ê†áÂøó‰ΩçÊ∏ÖÈõ∂ÔºåÂÅúÊ≠¢Ê†°ÂáÜ
  343   3                  wheel_y_front_speed = 0;
  344   3                  wheel_y_rear_speed = 0;
  345   3              }
  346   2          }
  347   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1466     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =        28     ------
  bit size             =         1     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        24     ------
End of Module Information.

C251 COMPILER V5.60.0,  motor_driver_boards                                                26/04/24  14:43:24  PAGE 7   


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
